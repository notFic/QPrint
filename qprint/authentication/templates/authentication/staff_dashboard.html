{% load static %}
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Q-Print Staff Dashboard</title>
  <link rel="stylesheet" href="{% static 'qprint/css/staff_dashboard.css' %}">
</head>
<body>
  <!-- Fixed Header Bar -->
  <div class="header-bar" role="banner">
    <img src="{% static 'qprint/images/header.jpg' %}" alt="" aria-hidden="true">
    <button class="menu-btn" aria-label="Toggle sidebar" aria-controls="sidebar">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <line x1="3" y1="12" x2="21" y2="12"></line>
        <line x1="3" y1="6" x2="21" y2="6"></line>
        <line x1="3" y1="18" x2="21" y2="18"></line>
      </svg>
    </button>
    <div class="header-title">Q-Print</div>
  </div>

  <!-- Sidebar -->
  <div class="sidebar" id="sidebar" role="complementary" aria-label="Sidebar navigation">
    <div class="sidebar-header">
      <h2>Menu</h2>
      <button class="close-btn" aria-label="Close sidebar">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <line x1="18" y1="6" x2="6" y2="18"></line>
          <line x1="6" y1="6" x2="18" y2="18"></line>
        </svg>
      </button>
    </div>
    <div class="sidebar-content">
      <a href="#print-jobs">Print Jobs</a>
      <a href="#payments">Payments</a>
      <a href="#profile">Profile</a>
      <a href="#support">Support</a>
      <hr class="logout-divider">
      <a href="{% url 'logout' %}" class="logout-link">Logout</a>
    </div>
  </div>

  <!-- Backdrop -->
  <div class="backdrop" id="backdrop" aria-hidden="true"></div>

  <div class="container" role="main">
    <h1>Welcome, {{ user.username }}</h1>

    <!-- Stats row -->
    <div class="stats-grid">
      <div class="stat-card" role="region" aria-label="Pending print jobs">
        <div class="stat-icon" aria-hidden="true">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.6" d="M6 9v6h12V9M9 21h6M6 5h12v4H6z"></path>
          </svg>
        </div>
        <div class="stat-content">
          <h3>Pending Print Jobs</h3>
          <p id="pending-print-count">{{ pending_count }}</p>
        </div>
      </div>
      <div class="stat-card" role="region" aria-label="Pending invoices">
        <div class="stat-icon" aria-hidden="true">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.6" d="M7 7h10M7 11h10M7 15h6M21 8v8a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8"></path>
          </svg>
        </div>
        <div class="stat-content">
          <h3>Pending Invoices</h3>
          <p id="pending-invoices-count">{{ pending_invoices_count }}</p>
        </div>
      </div>
    </div>

    <!-- Main content grid -->
    <div class="content-grid">
      <div class="center-col">
        <!-- Print Jobs Table -->
        <div class="card" aria-labelledby="printJobTitle">
          <h2 id="printJobTitle">All Print Jobs</h2>
          <div class="search-box">
            <input id="jobSearch" placeholder="Search by filename...">
          </div>
          <table>
            <thead>
              <tr><th>File</th><th>User</th><th>Submitted</th><th>Status</th><th>Action</th></tr>
            </thead>
            <tbody id="jobsTbody">
              {% for job in print_jobs %}
              <tr>
                <td>{{ job.file_name }}</td>
                <td>{{ job.username }}</td>
                <td>{{ job.submitted_at|date:"Y-m-d H:i A" }}</td>
                <td>
                  <span class="badge
                    {% if job.status == 'Pending' %}badge-pending{% elif job.status == 'Completed' %}badge-completed{% elif job.status == 'Cancelled' %}badge-cancelled{% endif %}">
                    {{ job.status }}
                  </span>
                </td>
                <td>
                  {% if job.status == 'Pending' %}
                  <button class="cancel-btn" data-job-id="{{ job.id }}">Cancel</button>
                  {% endif %}
                </td>
              </tr>
              {% empty %}
              <tr><td colspan="5">No print jobs found.</td></tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>

      <div class="right-col">
        <!-- Profile -->
        <div class="card" aria-labelledby="profileTitle">
          <h2 id="profileTitle">Profile</h2>
          <div class="profile-info">
            <p><strong>Name:</strong> {{ user.username }}</p>
            <p><strong>Email:</strong> {{ user.email }}</p>
            <p><strong>Role:</strong> Staff</p>
          </div>
        </div>

        <!-- Invoices -->
        <div class="card" aria-labelledby="paymentsTitle">
          <h2 id="paymentsTitle">Invoices</h2>
          <table>
            <thead>
              <tr><th>Invoice ID</th><th>Student</th><th>Amount</th><th>Status</th></tr>
            </thead>
            <tbody>
              {% for invoice in invoices %}
              <tr>
                <td>{{ invoice.id }}</td>
                <td>{{ invoice.student.username }}</td>
                <td>{{ invoice.amount }}</td>
                <td>
                  <span class="badge
                    {% if invoice.status == 'Pending' %}badge-pending{% elif invoice.status == 'Paid' %}badge-completed{% elif invoice.status == 'Cancelled' %}badge-cancelled{% endif %}">
                    {{ invoice.status }}
                  </span>
                </td>
              </tr>
              {% empty %}
              <tr><td colspan="4">No invoices found.</td></tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Sidebar toggle functionality
    (function(){
      const menuBtn = document.querySelector('.menu-btn');
      const sidebar = document.querySelector('.sidebar');
      const closeBtn = document.querySelector('.close-btn');
      const backdrop = document.querySelector('.backdrop');

      function toggleSidebar() {
        sidebar.classList.toggle('open');
        backdrop.classList.toggle('active');
      }

      menuBtn.addEventListener('click', toggleSidebar);
      closeBtn.addEventListener('click', toggleSidebar);
      backdrop.addEventListener('click', toggleSidebar);
    })();

    // File upload preview
    (function(){
      const fileInput = document.getElementById('fileInput');
      const previewBox = document.getElementById('previewBox');

      fileInput.addEventListener('change', function(){
        previewBox.innerHTML = '';
        const file = fileInput.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = function(e) {
            if (file.type.startsWith('image/')) {
              const img = document.createElement('img');
              img.src = e.target.result;
              previewBox.appendChild(img);
            } else {
              const p = document.createElement('p');
              p.textContent = `File: ${file.name}`;
              previewBox.appendChild(p);
            }
          };
          reader.readAsDataURL(file);
        }
      });
    })();

    // Search filter for print job history
    (function(){
      const input = document.getElementById('jobSearch');
      const tbody = document.getElementById('jobsTbody');

      input.addEventListener('input', function(){
        const q = input.value.trim().toLowerCase();
        const rows = tbody.querySelectorAll('tr');
        rows.forEach(r => {
          const text = r.textContent.toLowerCase();
          r.style.display = text.includes(q) ? '' : 'none';
        });
      });
    })();

    // Print job cancellation
    (function(){
      const jobsTbody = document.getElementById('jobsTbody');
      jobsTbody.addEventListener('click', function(e){
        if (!e.target.classList.contains('cancel-btn')) return;
        const btn = e.target;
        const row = btn.closest('tr');
        const badge = row.querySelector('.badge');
        badge.classList.remove('badge-pending');
        badge.classList.add('badge-cancelled');
        badge.textContent = 'Cancelled';
        btn.remove();
        // Update pending count
        const pendingCountEl = document.getElementById('pending-print-count');
        let n = parseInt(pendingCountEl.textContent, 10) || 0;
        if (n > 0) pendingCountEl.textContent = (n - 1).toString();
      });
    })();
  </script>
</body>
</html>